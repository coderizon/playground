# Refactor Progress — ML Playground Vision Alignment

## React Migration (Feb 2025)

- **Framework Switch**: Replaced Alpine.js with React to address persistent DOM race conditions during camera stream initialization (`x-ref` within `x-if` blocks).
- **Component Architecture**:
  - Migrated all pages (`Home`, `Collect`, `Train`, `Infer`) to functional React components.
  - Implemented `useSession` hook to bridge the existing `sessionStore` via `useSyncExternalStore`.
  - Used `useEffect` and `useRef` for stable video element references and stream lifecycle management.
- **Key Fixes**:
  - Resolved "Recorder-Vorschau konnte nicht initialisiert werden" crash by ensuring video elements are mounted before attaching streams.
  - Fixed empty prediction output in Inference panel by correctly using selectors (`getInferencePredictions`) to map raw probabilities to class names.
  - Eliminated "toast loop" crashes caused by Alpine.js reactivity cycles.
- **Styling Fixes**:
  - Configured `tailwind.config.js` to scan `.jsx`/`.tsx` files, resolving unstyled components.
  - Updated `postcss.config.js` to modern object syntax for better Vite compatibility.
  - Removed manual CSS link in `index.html` to prevent raw style injection and rely on Vite's bundle.
- **Feature Restoration**:
  - Restored "Gestenerkennung" hand landmark visualization during data collection.
  - Implemented `HandPoseService` to bridge the legacy `hand-pose-detection` asset.
  - Added `GesturePreview` overlay component to `DatasetRecorder` for real-time skeleton drawing.
- **Gestenerkennung Inference Fix**:
  - Implemented dynamic feature extraction in `modelBridge.js` to correctly use Hand Landmarks for 'gesture-recognition' tasks and MobileNet for image tasks.
  - Fixed a critical bug where `classIndex` became stale in `recordedSamples` when classes were added/removed, causing inference to fail with more than 2 classes.
  - Updated classifier initialization to dynamically adjust `inputShape` based on the chosen feature extractor.
- **UI/UX Enhancement**:
  - Improved visibility of the "Session verwerfen" button on the Inference page by applying `primary danger` styling, highlighting its destructive nature.
- **Cleanup**: Removed all Alpine.js dependencies and legacy setup scripts.

## Current State Snapshot (Jan 2025)

- **Architecture switcher**: `index.html` now loads `/src/bootstrap.js` which immediately boots the SPA (`src/app/bootstrap.js`), hides the old DOM, and mounts the router (`src/app/routes/router.js`). With the legacy Collect/Train/Infer columns, BLE modal, and landing marquee removed, the SPA is now the sole UI—our refactor path is a full rewrite to the SPA described in `vision.md`, so no state mirroring or dual rendering is required.
- **Structure parity**: The source tree mirrors `vision.md` §11 — `src/app` holds store/routes/guards/bootstrap, while `src/pages`, `src/components`, `src/services`, `src/styles`, and `src/assets` are sibling directories. Legacy prototype folders/files (`bluetooth`, `camera`, `ml`, `ui`, `state.js`, `constants.js`, `domRefs.js`) were removed, and BLE device modules now live under `src/services/edge/devices`.
- **Session store & selectors**: `src/app/store/sessionStore.js` holds the full session model (classes, training, inference, edge state). Derived helpers live in `src/app/store/selectors.js`. Guards (`src/app/guards/navigation.js`) enforce the journey invariants and pages subscribe to the store to enable/disable controls in real time. Dataset resets are now blocked while training runs, with dedicated tests (`tests/store/sessionStore.dataset.test.mjs`) ensuring idle vs running behavior stays consistent.
- **Navigation controller**: `src/app/routes/navigationController.js` wraps all `sessionStore.setStep` calls with guard-aware helpers (`goHome/goCollect/goTrain/goInfer`) that consult an inference-running confirmation before navigating, and `tests/routes/navigationController.test.mjs` ensures transitions only fire when invariants hold (including decline paths). Companion controllers manage destructive actions: `sessionController` for full-session resets and `classController` for class/dataset deletes, each with regression tests under `tests/routes/sessionController.test.mjs` and `tests/routes/classController.test.mjs`. A global shortcut manager binds `Ctrl+Shift+D` (session verwerfen) and `Ctrl+Shift+H` (zurück zu Home) to those controllers so keyboard-only users always have parity.
- **Browser history + leave guards**: `src/app/routes/historySync.js` keeps `window.history`/hash in lockstep with session steps, restores the right page on refresh/back, and falls back safely when guards block navigation. `src/app/routes/navigationGuards.js` registers a global `beforeunload` warning and reuses the confirmation helper. `createInferenceController` owns the reusable “ensure inference stopped” flow (`tests/routes/inferenceController.test.mjs`) that pages call before opening destructive dialogs, and it now emits toasts whenever it has to stop a running inference on the user’s behalf. `tests/routes/historySync.test.mjs` stubs the browser to cover initial hash hydration, pushState, and popstate failure recovery.
- **Alpine component layer**:
  - `classList` now focuses on class creation, naming, and dataset status messaging.
  - `datasetRecorder` components own camera permissions, microphone-based clip capture (MediaRecorder), readiness hints, and destructive discards while piping embeddings into the TF.js bridge; toast notifications surface permission failures inline. Per-sample deletes and dataset resets now route through dedicated controllers/confirm dialogs so training locks can block the action consistently, and audio recorders now surface a background-noise guidance pill that reports how many 20s clips exist (with timestamps) plus a one-click CTA to capture another background take.
  - Audio recorder presets mirror the ml-speech guidance: quick 2s clips plus a 20s background capture with inline hints, completion status, CTA buttons, and inline playback so students can review what they just captured. Camera samples now surface derived thumbnails, hover-activated frame strips, coverage summaries, a manual scrub slider, annotations with character counters, and timestamps/source metadata so learners can polish datasets without re-recording. Collect and Train summaries reuse the same background-audio checks so missing noise captures are called out anywhere the user makes next-step decisions.
  - Modality guidance: audio recorder shows progress meters + short-clip analytics, camera recorder captures frame thumbnails + variation hints.
  - `trainingPanel` wraps TF.js intents (start/abort), surfaces dataset readiness summaries, and broadcasts locking hints so Collect UI disables itself while training runs. Training intents now route through `trainingController`, which confirms aborts and centralizes start calls. It also mirrors `training.lastRun` metadata (status, timestamp, failure reason), compares it to each class' `dataset.lastUpdatedAt`, updates the primary CTA (`Training starten` → `Erneut trainieren (neue Daten)`) plus inline hints so learners immediately see why a retrain is recommended, surfaces microphone-specific background requirements, and now exposes keyboard shortcuts (`T` to start, `A/Esc` to abort) so the training loop is fully operable without a mouse.
  - A shared `permissionAlerts` Alpine component listens to `sessionStore.permissions` to surface camera/microphone failures across Collect and Inference. Recording components and `inferenceControls` now call `sessionStore.setPermissionState` whenever permissions succeed or fail, so blocked devices produce dedicated warning banners (with guidance copy) instead of being limited to transient toasts. The edge panel reuses the same metadata plus the training retry context: the streaming toggle is now disabled (with inline hints + toasts) whenever the last training run is stale or camera permissions are blocked, preventing learners from sending outdated/unsafe predictions to hardware.
  - Status labels that inform navigation decisions (`collect-lock-hint`, summary messages, training hints, inference status, edge streaming notices, etc.) now expose `role="status"` + `aria-live="polite"` so screen readers announce readiness/lock changes immediately without forcing learners to hunt for updates.
  - `collectSummary` surfaces overall readiness (classes, samples, blockers) directly on the Collect page and now flags missing audio background captures when the session uses the microphone; `inferenceControls` manages camera permissions, start/stop intents, keyboard shortcuts (P start/O stop), and navigation safety copy; `predictionPanel` subscribes to inference predictions, throttles updates, and communicates streaming status so users get clear feedback even on slower devices. Collect’s training hint now renders via the shared `renderNoticeBanner`, the empty state is its own Alpine component with inline guidance + CTA, class cards are modularized (`classCard` + `datasetRecorder`), the Home session panel exposes the global shortcut map (Ctrl+Shift+D/H), and the Home task grid carries explicit keyboard instructions + `aria-labelledby`/`aria-describedby` hooks so assistive tech announces each card’s name and description. Training’s sidebar now reuses a dedicated `trainingSummaryPanel` component so readiness issues and audio checks stay in sync with the store without bloating the CTA logic.
  - Inference page session-discard controls now defer to `sessionController`, so the shared confirm dialog plus inference guard stop live predictions before allowing a destructive reset, regardless of where the action is triggered. Combined with `classController`/`sampleController`/`edgeController`, every destructive action (session/class/dataset/sample deletes and BLE disconnects) now flows through guard-aware controllers with confirmations + toasts.
  - Global confirm dialog + notice banners provide consistent messaging. The confirm dialog now mounts once during app bootstrap, so controllers (session/class/edge) and the inference guard can open it on any page without relying on Collect’s markup; session discard continues to route through the shared guard before showing the destructive confirm. The dialog now traps focus only while open, exposes Escape-to-close, and wires `aria-labelledby`/`aria-describedby` so assistive tech hears the correct title/message pairing, and `renderNoticeBanner` now emits `role="status"`/`aria-live` so inference/collect notices announce changes immediately.
  - Edge panel component connects BLE devices, toggles streaming, mirrors connection/streaming state on the inference page, persists the last selected device/error in `sessionStore.edge`, auto-opens the BLE modal on failures, highlights the selected device with inline error copy, shows device thumbnails plus quick-start steps for Arduino, Micro:bit und Calliope, and now provides a11y affordances (focus trap, Escape handling, labeled dialog) so keyboard-only users can recover from BLE errors. The panel defers all destructive actions (disconnect, streaming toggles) to the inference guard + new `getEdgeStreamingContext` selector so inference must stop before disconnecting and streaming stays disabled until camera permissions are restored and stale datasets retrained. BLE disconnects now route through a dedicated `edgeController` that confirms the action, uses the inference guard to stop live predictions first, and emits toasts so learners always understand why the hardware session stopped.
- **Styling + accessibility foundation**: Tailwind entry point lives in `src/styles/main.css` (with `@tailwind base/components/utilities` plus a `@layer components` block). That sheet now defines the SPA’s shared tokens (buttons, notices, modals) and page layouts for Home/Collect/Train/Infer, so the new journey renders with consistent spacing/typography without the orphaned `collect.css`. The same layer ships the shared `.visually-hidden` helper, consistent focus-visible rings, and the SPA-specific hero/guardrail styles—no legacy landing assets remain in the bundle.
- **Flow coverage**:
  - **Home**: task/model grid wired to the store, session discard/back-to-home controls, and a dedicated hero that restates the declarative journey + guardrails so the SPA itself now carries the onboarding messaging (legacy landing copy is no longer required).
  - **Collect**: classes + recording previews, dataset readiness gating, summary panel with per-class blockers, training progression guard.
  - **Train**: MobileNet feature extraction + real classifier training via `modelBridge.js`, progress bar, guard-driven navigation, blocker list fed by dataset readiness metadata.
  - **Infer**: Live camera inference loop, FPS-aware start/stop guard via `inferenceControls` (with before-unload protection + confirmations), throttled prediction display, explicit streaming toggle/notice. Die „Gesichtsvorschau“-Aufgabe nutzt jetzt den Mediapipe Face Landmarker mit Canvas-Overlay und zeigt die Blendshape-Wahrscheinlichkeiten ohne Training direkt in der Vorhersageliste an. The legacy preview column and BLE modal were removed so the SPA edge panel remains the sole implementation.
- **Services**:
  - `services/media/cameraService.js` centralizes camera stream handling.
  - `services/ml/modelBridge.js` uses TF.js to capture embeddings, train, and infer.
  - `services/ml/liveInference.js` runs the inference loop.
  - `services/ml/mockTraining.js` + `mockInference.js` remain as fallbacks for future tests.
  - `services/edge/edgeService.js` wraps BLE modules, tracks connection state, streams predictions to Arduino/Micro:bit/Calliope, and flags streaming errors as edge status updates; regression tests in `tests/store/sessionStore.edge.test.mjs` cover edge state persistence/contracts, `tests/services/edgeService.test.mjs` fakes the BLE stack to verify streaming toggles + error propagation end to end, and `docs/ble-hardware-qa.md` captures the release checklist for exercising real devices.
  - `src/config/externalResources.js` now pins the external TF.js/Mediapipe URLs that both the legacy prototype and SPA share, making version bumps + self-hosting plans explicit. `src/utils/loadTf.js` consumes that config so `/src/bootstrap.js` injects the pinned TF.js script exactly once, which means swapping to a self-hosted bundle only requires flipping the config constant.
- **Documentation & onboarding**: `docs/onboarding.md` captures the development workflow (setup, architecture map, controllers/guardrails, testing expectations) so new contributors can ramp up without institutional knowledge. Component-specific notes continue to live in `docs/components.md`, which now points back to the onboarding guide.

## Remaining Work to Fulfill `vision.md`

All pillars in `vision.md` are now satisfied. Continue treating this file + `docs/onboarding.md` as living documents whenever new features or slices are added.

Keep referencing `refactoring-plans/vision.md` as the contract; this file tracks implementation status and outstanding work.
