# Refactor Progress — ML Playground Vision Alignment

## React Migration (Feb 2025)

- **Framework Switch**: Replaced Alpine.js with React to address persistent DOM race conditions during camera stream initialization (`x-ref` within `x-if` blocks).
- **Component Architecture**:
  - Migrated all pages (`Home`, `Collect`, `Train`, `Infer`) to functional React components.
  - Implemented `useSession` hook to bridge the existing `sessionStore` via `useSyncExternalStore`.
  - Used `useEffect` and `useRef` for stable video element references and stream lifecycle management.
- **Key Fixes**:
  - Resolved "Recorder-Vorschau konnte nicht initialisiert werden" crash by ensuring video elements are mounted before attaching streams.
  - Fixed empty prediction output in Inference panel by correctly using selectors (`getInferencePredictions`) to map raw probabilities to class names.
  - Eliminated "toast loop" crashes caused by Alpine.js reactivity cycles.
- **Styling Fixes**:
  - Configured `tailwind.config.js` to scan `.jsx`/`.tsx` files, resolving unstyled components.
  - Updated `postcss.config.js` to modern object syntax for better Vite compatibility.
  - Removed manual CSS link in `index.html` to prevent raw style injection and rely on Vite's bundle.
- **Feature Restoration**:
  - Restored "Gestenerkennung" hand landmark visualization during data collection.
  - Implemented `HandPoseService` to bridge the legacy `hand-pose-detection` asset.
  - Added `GesturePreview` overlay component to `DatasetRecorder` for real-time skeleton drawing.
- **Gestenerkennung Inference Fix**:
  - Implemented dynamic feature extraction in `modelBridge.js` to correctly use Hand Landmarks for 'gesture-recognition' tasks and MobileNet for image tasks.
  - Fixed a critical bug where `classIndex` became stale in `recordedSamples` when classes were added/removed, causing inference to fail with more than 2 classes.
  - Updated classifier initialization to dynamically adjust `inputShape` based on the chosen feature extractor.
- **UI/UX Enhancement**:
  - Improved visibility of the "Session verwerfen" button on the Inference page by applying `primary danger` styling, highlighting its destructive nature.
- **Cleanup**: Removed all Alpine.js dependencies and legacy setup scripts. Resolved dynamic import warnings in `handPoseService.js` for Vite compatibility.

## Current State Snapshot (Dec 2025)

- **Architecture switcher**: `index.html` now loads `/src/bootstrap.js` which immediately boots the SPA (`src/app/bootstrap.js`), hides the old DOM, and mounts the router (`src/app/routes/router.js`). With the legacy Collect/Train/Infer columns, BLE modal, and landing marquee removed, the SPA is now the sole UI—our refactor path is a full rewrite to the SPA described in `vision.md`, so no state mirroring or dual rendering is required.
- **Structure parity**: The source tree mirrors `vision.md` §11 — `src/app` holds store/routes/guards/bootstrap, while `src/pages`, `src/components`, `src/services`, `src/styles`, and `src/assets` are sibling directories. Legacy prototype folders/files (`bluetooth`, `camera`, `ml`, `ui`, `state.js`, `constants.js`, `domRefs.js`) were removed, and BLE device modules now live under `src/services/edge/devices`.
- **Compact class cards**: Collect's classes now render as tight cards with a single preview block, a summary row that exposes the recorded count plus the CTA to "Beispiele verwalten", and a snapshot overlay that keeps the last captured frame visible while letting the live stream stay active for re-recording; zero-state copy no longer repeats "Noch keine Beispiele" / "Noch keine Daten" and the summary text only describes active recording progress to avoid repeating “Beispiele verwalten”, keeping the layout lean while the sample modal + discard controls remain intact for deeper dataset management, and the camera switch control now sits at the bottom-right of the preview with the refreshed double-arrow icon so it stays out of the countdown overlay area.
- **Recorder UX**: The hold-to-record button now enforces a short touch-hold (≈250 ms) before the countdown starts, so brief accidental taps on mobile screens don’t trigger a partial countdown/black screen while still starting immediately for mouse interactions.
- **Snapshot fidelity**: Camera dataset thumbnails now capture a higher-resolution frame (mirrored when the live stream is mirrored) and the Collect UI overlays that thumbnail while keeping the live preview running so subsequent recordings still show a countdown + video feed instead of blanking out.
- **Snapshot fidelity**: Camera dataset thumbnails now capture frames at 360px height with a 0.9 JPEG quality, so the “Letzter Frame” preview matches the stored samples’ orientation while the overlay still keeps the live preview active for re-recording.
- **Session store & selectors**: `src/app/store/sessionStore.js` holds the full session model (classes, training, inference, edge state). Derived helpers live in `src/app/store/selectors.js`. Guards (`src/app/guards/navigation.js`) enforce the journey invariants and pages subscribe to the store to enable/disable controls in real time. Dataset resets are now blocked while training runs, with dedicated tests (`tests/store/sessionStore.dataset.test.mjs`) ensuring idle vs running behavior stays consistent.
- **Navigation controller**: `src/app/routes/navigationController.js` wraps all `sessionStore.setStep` calls with guard-aware helpers (`goHome/goCollect/goTrain/goInfer`) that consult an inference-running confirmation before navigating, and `tests/routes/navigationController.test.mjs` ensures transitions only fire when invariants hold (including decline paths). Companion controllers manage destructive actions: `sessionController` for full-session resets and `classController` for class/dataset deletes, each with regression tests under `tests/routes/sessionController.test.mjs` and `tests/routes/classController.test.mjs`. A global shortcut manager binds `Ctrl+Shift+D` (session verwerfen) and `Ctrl+Shift+H` (zurück zu Home) to those controllers so keyboard-only users always have parity.
- **Browser history + leave guards**: `src/app/routes/historySync.js` keeps `window.history`/hash in lockstep with session steps, restores the right page on refresh/back, and falls back safely when guards block navigation. `src/app/routes/navigationGuards.js` registers a global `beforeunload` warning and reuses the confirmation helper. `createInferenceController` owns the reusable “ensure inference stopped” flow (`tests/routes/inferenceController.test.mjs`) that pages call before opening destructive dialogs, and it now emits toasts whenever it has to stop a running inference on the user’s behalf. `tests/routes/historySync.test.mjs` stubs the browser to cover initial hash hydration, pushState, and popstate failure recovery.
- **Alpine component layer**:
  - `classList` now focuses on class creation, naming, and dataset status messaging.
  - `datasetRecorder` components own camera permissions, microphone-based clip capture (MediaRecorder), readiness hints, and destructive discards while piping embeddings into the TF.js bridge; toast notifications surface permission failures inline. Per-sample deletes and dataset resets now route through dedicated controllers/confirm dialogs so training locks can block the action consistently, and audio recorders now surface a background-noise guidance pill that reports how many 20s clips exist (with timestamps) plus a one-click CTA to capture another background take.
  - **Fix**: `DatasetRecorder` now correctly detaches the camera stream and hides the live preview when the dataset is in the 'READY' state, preventing unnecessary resource usage and visual clutter while retaining the "Datensatz bereit" status.
  - **Fix**: Corrected camera preview aspect ratio on large screens by enforcing a 4:3 ratio for both `DatasetRecorder` and `InferencePanel` videos. This prevents the "zoomed in" cropping effect observed on desktop layouts where full-width containers previously caused vertical cropping.
  - **Fix**: Training no longer clears recorded samples upon completion. Previously, `resetSamples()` was called in the `finally` block of `trainWithRecordedSamples`, destroying the tensors and preventing users from re-training ("Erneut trainieren") without re-recording. Samples now persist until the session is discarded or explicit deletion.
  - **Fix**: Resolved layout issues in `DatasetRecorder` where the video stream didn't fully fill the card (leaving empty spots due to padding) and displaced the "Datensatz bereit" text (causing cropping). The video preview is now absolutely positioned, ensuring edge-to-edge coverage and correct text centering.
  - **Feature**: Implemented media device switching for both cameras and microphones. A new "Switch Device" control (cycling button) appears in `DatasetRecorder` and `InferencePanel` when multiple devices are detected, persisting the selection globally in the session store. This allows users to easily toggle between front/back cameras or different microphones.
  - **Feature**: Introduced a system-wide `NotificationTray` that unifies transient toasts and persistent system hints (e.g., permissions, training locks, readiness requirements) into a single floating stack. This replaces the ad-hoc floating toolbar in the Collect page and provides a consistent, auto-revealing notification center across the entire application.
  - Dataset sample management now renders as a stacked album trigger instead of a long inline list. Clicking the stack opens a focus-trapped modal that shows every sample, supports hover scrubbing, and exposes multi-select bulk deletion through `sampleController`, so densely populated classes stay compact while advanced cleanup remains one click away. The stack + modal are visible even before the first recording so classes never jump in height, and empty-state copy surfaces guidance rather than hiding the controls.
  - The gesture hand-landmark overlay (`GesturePreview`) now remains active whenever the camera preview is rendering so the skeleton stays visible both while capturing a new example and while showing the stored snapshot, preventing the “overlay disappears during recording” regression.
  - Recorder controls now sit below the sample stack, keeping the album and counter immediately visible before the user decides to start/stop recording or discard data.
  - The dataset discard CTA now sits inside the Samples panel header (warning button) so deleting data stays contextually grouped with sample management, while per-class delete remains in the card header (red, right aligned) for quick access.
  - Sample previews now show the latest captured frame instead of stacking thumbnails, reinforcing the album-as-entry affordance while keeping the click target compact.
  - Camera previews now auto-attach as soon as a class card mounts, so the live stream is visible even before recording starts; recording uses its own handle so stopping capture no longer blanks the preview.
  - Live recording guidance copy now renders under the camera preview instead of overlaying the video so learners keep an unobstructed view of the stream.
  - The Samples card now doubles as the dataset counter: before any captures it shows `x/y Samples aufgenommen`, and once data exists it switches to the `n Samples verwalten` affordance so the class header stays clean.
  - Class cards now flow in a responsive 1/3/4 column grid (mobile/tablet/desktop-xl) so screen real estate is used efficiently without crowding the mobile layout.
  - Collect guard notices (training running, empty class, recording running) now appear as floating toasts in the bottom-right corner, avoiding layout shifts when hints toggle on/off.
  - Floating hints can be toggled via a bottom-right “i” button that disables itself when there’s nothing to show, keeping the UI quieter by default.
  - The camera recorder now captures an initial frame immediately and samples roughly twice per second, keeping the live preview, stacked album, and counters perfectly in sync with the stream so users no longer perceive 1 fps capture delays after pressing “Aufnahme starten”.
  - Class cards now inherit their dataset status color (ready, recording, empty/error) as a faint background wash and badge, so the current readiness is immediately scannable even with many classes on the page.
  - The Collect toolbar is now a single bar that houses the “Klasse hinzufügen” action plus readiness metrics (total classes, ready classes, sample count). This avoids the double-row layout from the prototype while keeping the background audio warnings inline with the CTA.
  - Audio recorder presets mirror the ml-speech guidance: quick 2s clips plus a 20s background capture with inline hints, completion status, CTA buttons, and inline playback so students can review what they just captured. Camera samples now surface derived thumbnails, hover-activated frame strips, coverage summaries, a manual scrub slider, annotations with character counters, and timestamps/source metadata so learners can polish datasets without re-recording. Collect and Train summaries reuse the same background-audio checks so missing noise captures are called out anywhere the user makes next-step decisions.
  - Modality guidance: audio recorder shows progress meters + short-clip analytics, camera recorder captures frame thumbnails + variation hints.
  - `trainingPanel` wraps TF.js intents (start/abort), surfaces dataset readiness summaries, and broadcasts locking hints so Collect UI disables itself while training runs. Training intents now route through `trainingController`, which confirms aborts and centralizes start calls. It also mirrors `training.lastRun` metadata (status, timestamp, failure reason), compares it to each class' `dataset.lastUpdatedAt`, updates the primary CTA (`Training starten` → `Erneut trainieren (neue Daten)`) plus inline hints so learners immediately see why a retrain is recommended, surfaces microphone-specific background requirements, and now exposes keyboard shortcuts (`T` to start, `A/Esc` to abort) so the training loop is fully operable without a mouse.
  - A shared `permissionAlerts` Alpine component listens to `sessionStore.permissions` to surface camera/microphone failures across Collect and Inference. Recording components and `inferenceControls` now call `sessionStore.setPermissionState` whenever permissions succeed or fail, so blocked devices produce dedicated warning banners (with guidance copy) instead of being limited to transient toasts. The edge panel reuses the same metadata plus the training retry context: the streaming toggle is now disabled (with inline hints + toasts) whenever the last training run is stale or camera permissions are blocked, preventing learners from sending outdated/unsafe predictions to hardware.
  - Status labels that inform navigation decisions (`collect-lock-hint`, summary messages, training hints, inference status, edge streaming notices, etc.) now expose `role="status"` + `aria-live="polite"` so screen readers announce readiness/lock changes immediately without forcing learners to hunt for updates.
  - `collectSummary` surfaces overall readiness (classes, samples, blockers) directly on the Collect page and now flags missing audio background captures when the session uses the microphone; `inferenceControls` manages camera permissions, start/stop intents, keyboard shortcuts (P start/O stop), and navigation safety copy; `predictionPanel` subscribes to inference predictions, throttles updates, and communicates streaming status so users get clear feedback even on slower devices. Collect’s training hint now renders via the shared `renderNoticeBanner`, the empty state is its own Alpine component with inline guidance + CTA, class cards are modularized (`classCard` + `datasetRecorder`), the Home session panel exposes the global shortcut map (Ctrl+Shift+D/H), and the Home task grid carries explicit keyboard instructions + `aria-labelledby`/`aria-describedby` hooks so assistive tech announces each card’s name and description. Training’s sidebar now reuses a dedicated `trainingSummaryPanel` component so readiness issues and audio checks stay in sync with the store without bloating the CTA logic.
  - Inference page session-discard controls now defer to `sessionController`, so the shared confirm dialog plus inference guard stop live predictions before allowing a destructive reset, regardless of where the action is triggered. Combined with `classController`/`sampleController`/`edgeController`, every destructive action (session/class/dataset/sample deletes and BLE disconnects) now flows through guard-aware controllers with confirmations + toasts.
  - Global confirm dialog + notice banners provide consistent messaging. The confirm dialog now mounts once during app bootstrap, so controllers (session/class/edge) and the inference guard can open it on any page without relying on Collect’s markup; session discard continues to route through the shared guard before showing the destructive confirm. The dialog now traps focus only while open, exposes Escape-to-close, and wires `aria-labelledby`/`aria-describedby` so assistive tech hears the correct title/message pairing, and `renderNoticeBanner` now emits `role="status"`/`aria-live` so inference/collect notices announce changes immediately.
  - Edge panel component connects BLE devices, toggles streaming, mirrors connection/streaming state on the inference page, persists the last selected device/error in `sessionStore.edge`, auto-opens the BLE modal on failures, highlights the selected device with inline error copy, shows device thumbnails plus quick-start steps for Arduino, Micro:bit und Calliope, and now provides a11y affordances (focus trap, Escape handling, labeled dialog) so keyboard-only users can recover from BLE errors. The panel defers all destructive actions (disconnect, streaming toggles) to the inference guard + new `getEdgeStreamingContext` selector so inference must stop before disconnecting and streaming stays disabled until camera permissions are restored and stale datasets retrained. BLE disconnects now route through a dedicated `edgeController` that confirms the action, uses the inference guard to stop live predictions first, and emits toasts so learners always understand why the hardware session stopped.
- **Styling + accessibility foundation**: Tailwind entry point lives in `src/styles/main.css` (with `@tailwind base/components/utilities` plus a `@layer components` block). That sheet now defines the SPA’s shared tokens (buttons, notices, modals) and page layouts for Home/Collect/Train/Infer, so the new journey renders with consistent spacing/typography without the orphaned `collect.css`. The same layer ships the shared `.visually-hidden` helper, consistent focus-visible rings, and the SPA-specific hero/guardrail styles—no legacy landing assets remain in the bundle. The app shell now stretches edge-to-edge without rounded corners or faux card borders so every page occupies the full viewport height.
- **Flow coverage**:
  - **Home**: task/model grid wired to the store, session discard/back-to-home controls, and a dedicated hero that restates the declarative journey + guardrails so the SPA itself now carries the onboarding messaging (legacy landing copy is no longer required).
  - **Collect**: classes + recording previews, dataset readiness gating, summary panel with per-class blockers, training progression guard.
  - **Train**: MobileNet feature extraction + real classifier training via `modelBridge.js`, progress bar, guard-driven navigation, blocker list fed by dataset readiness metadata.
  - **Infer**: Live camera inference loop, FPS-aware start/stop guard via `inferenceControls` (with before-unload protection + confirmations), throttled prediction display, explicit streaming toggle/notice. Die „Gesichtsvorschau“-Aufgabe nutzt jetzt den Mediapipe Face Landmarker mit Canvas-Overlay und zeigt die Blendshape-Wahrscheinlichkeiten ohne Training direkt in der Vorhersageliste an. The legacy preview column and BLE modal were removed so the SPA edge panel remains the sole implementation.
- **Services**:
  - `services/media/cameraService.js` centralizes camera stream handling.
  - `services/ml/modelBridge.js` uses TF.js to capture embeddings, train, and infer.
  - `services/ml/liveInference.js` runs the inference loop.
  - `services/ml/mockTraining.js` + `mockInference.js` remain as fallbacks for future tests.
  - `services/edge/edgeService.js` wraps BLE modules, tracks connection state, streams predictions to Arduino/Micro:bit/Calliope, and flags streaming errors as edge status updates; regression tests in `tests/store/sessionStore.edge.test.mjs` cover edge state persistence/contracts, `tests/services/edgeService.test.mjs` fakes the BLE stack to verify streaming toggles + error propagation end to end, and `docs/ble-hardware-qa.md` captures the release checklist for exercising real devices.
  - `src/config/externalResources.js` now pins the external TF.js/Mediapipe URLs that both the legacy prototype and SPA share, making version bumps + self-hosting plans explicit. `src/utils/loadTf.js` consumes that config so `/src/bootstrap.js` injects the pinned TF.js script exactly once, which means swapping to a self-hosted bundle only requires flipping the config constant.
- **Documentation & onboarding**: `docs/onboarding.md` captures the development workflow (setup, architecture map, controllers/guardrails, testing expectations) so new contributors can ramp up without institutional knowledge. Component-specific notes continue to live in `docs/components.md`, which now points back to the onboarding guide.

## Remaining Work to Fulfill `vision.md`

All pillars in `vision.md` are now satisfied. Continue treating this file + `docs/onboarding.md` as living documents whenever new features or slices are added.

Keep referencing `refactoring-plans/vision.md` as the contract; this file tracks implementation status and outstanding work.
