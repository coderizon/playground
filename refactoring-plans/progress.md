# Refactor Progress — ML Playground Vision Alignment

## Current State Snapshot (Jan 2025)

- **Architecture switcher**: `index.html` now loads `/src/bootstrap.js`, which flips between the legacy prototype and the new SPA via `VITE_PLAYGROUND_APP`. `src/app/bootstrap.js` hides the old DOM, boots Alpine, and mounts the router (`src/app/routes/router.js`). The legacy shell is no longer treated as a co-equal UI—our refactor path is a full rewrite to the SPA described in `vision.md`, so no state mirroring or dual rendering is required.
- **Session store & selectors**: `src/app/store/sessionStore.js` holds the full session model (classes, training, inference, edge state). Derived helpers live in `src/app/store/selectors.js`. Guards (`src/app/guards/navigation.js`) enforce the journey invariants and pages subscribe to the store to enable/disable controls in real time. Dataset resets are now blocked while training runs, with dedicated tests (`tests/store/sessionStore.dataset.test.mjs`) ensuring idle vs running behavior stays consistent.
- **Navigation controller**: `src/app/routes/navigationController.js` wraps all `sessionStore.setStep` calls with guard-aware helpers (`goHome/goCollect/goTrain/goInfer`) that consult an inference-running confirmation before navigating, and `tests/routes/navigationController.test.mjs` ensures transitions only fire when invariants hold (including decline paths). Companion controllers manage destructive actions: `sessionController` for full-session resets and `classController` for class/dataset deletes, each with regression tests under `tests/routes/sessionController.test.mjs` and `tests/routes/classController.test.mjs`.
- **Browser history + leave guards**: `src/app/routes/historySync.js` keeps `window.history`/hash in lockstep with session steps, restores the right page on refresh/back, and falls back safely when guards block navigation. `src/app/routes/navigationGuards.js` registers a global `beforeunload` warning and reuses the confirmation helper. `createInferenceController` owns the reusable “ensure inference stopped” flow (`tests/routes/inferenceController.test.mjs`) that pages call before opening destructive dialogs, and it now emits toasts whenever it has to stop a running inference on the user’s behalf. `tests/routes/historySync.test.mjs` stubs the browser to cover initial hash hydration, pushState, and popstate failure recovery.
- **Alpine component layer**:
  - `classList` now focuses on class creation, naming, and dataset status messaging.
  - `datasetRecorder` components own camera permissions, microphone-based clip capture (MediaRecorder), readiness hints, and destructive discards while piping embeddings into the TF.js bridge; toast notifications surface permission failures inline. Per-sample deletes now route through a dedicated controller/confirm dialog so training locks can block the action consistently, and audio recorders now surface a background-noise guidance pill that reports how many 20s clips exist (with timestamps) plus a one-click CTA to capture another background take.
  - Audio recorder presets mirror the ml-speech guidance: quick 2s clips plus a 20s background capture with inline hints, completion status, and inline playback so students can review what they just captured. Camera samples now surface derived thumbnails, hover-activated frame strips, coverage summaries, a manual scrub slider, and per-sample metadata (source, capture time, annotation counters) so learners can review and annotate data without re-recording.
  - Modality guidance: audio recorder shows progress meters + short-clip analytics, camera recorder captures frame thumbnails + variation hints.
  - `trainingPanel` wraps TF.js intents (start/abort), surfaces dataset readiness summaries, and broadcasts locking hints so Collect UI disables itself while training runs. Training intents now route through `trainingController`, which confirms aborts and centralizes start calls. It also mirrors `training.lastRun` metadata (status, timestamp, failure reason), compares it to each class' `dataset.lastUpdatedAt`, updates the primary CTA (`Training starten` → `Erneut trainieren (neue Daten)`) plus inline hints so learners immediately see why a retrain is recommended, surfaces microphone-specific background requirements, and now exposes keyboard shortcuts (`T` to start, `A/Esc` to abort) so the training loop is fully operable without a mouse.
  - A shared `permissionAlerts` Alpine component listens to `sessionStore.permissions` to surface camera/microphone failures across Collect and Inference. Recording components and `inferenceControls` now call `sessionStore.setPermissionState` whenever permissions succeed or fail, so blocked devices produce dedicated warning banners (with guidance copy) instead of being limited to transient toasts. The edge panel reuses the same metadata plus the training retry context: the streaming toggle is now disabled (with inline hints + toasts) whenever the last training run is stale or camera permissions are blocked, preventing learners from sending outdated/unsafe predictions to hardware.
  - Status labels that inform navigation decisions (`collect-lock-hint`, summary messages, training hints, inference status, edge streaming notices, etc.) now expose `role="status"` + `aria-live="polite"` so screen readers announce readiness/lock changes immediately without forcing learners to hunt for updates.
  - `collectSummary` surfaces overall readiness (classes, samples, blockers) directly on the Collect page and now flags missing audio background captures when the session uses the microphone; `inferenceControls` manages camera permissions, start/stop intents, keyboard shortcuts (P start/O stop), and navigation safety copy; `predictionPanel` subscribes to inference predictions, throttles updates, and communicates streaming status so users get clear feedback even on slower devices.
  - Global confirm dialog + notice banners provide consistent messaging. The confirm dialog now mounts once during app bootstrap, so controllers (session/class/edge) and the inference guard can open it on any page without relying on Collect’s markup; session discard continues to route through the shared guard before showing the destructive confirm.
  - Edge panel component connects BLE devices, toggles streaming, mirrors connection/streaming state on the inference page, persists the last selected device/error in `sessionStore.edge`, auto-opens the BLE modal on failures, highlights the selected device with inline error copy, shows device thumbnails plus quick-start steps for Arduino, Micro:bit und Calliope, and now provides a11y affordances (focus trap, Escape handling, labeled dialog) so keyboard-only users can recover from BLE errors. The panel defers all destructive actions (disconnect, streaming toggles) to the inference guard + new `getEdgeStreamingContext` selector so inference must stop before disconnecting and streaming stays disabled until camera permissions are restored and stale datasets retrained.
- **Styling foundation**: Tailwind entry point lives in `src/styles/main.css` (with `@tailwind base/components/utilities` plus a `@layer components` block). That sheet now defines the SPA’s shared tokens (buttons, notices, modals) and page layouts for Home/Collect/Train/Infer, so the new journey renders with consistent spacing/typography without the orphaned `collect.css`.
- **Flow coverage**:
  - **Home**: task/model grid wired to the store, session discard/back-to-home controls.
  - **Collect**: classes + recording previews, dataset readiness gating, summary panel with per-class blockers, training progression guard.
  - **Train**: MobileNet feature extraction + real classifier training via `modelBridge.js`, progress bar, guard-driven navigation, blocker list fed by dataset readiness metadata.
  - **Infer**: Live camera inference loop, FPS-aware start/stop guard via `inferenceControls` (with before-unload protection + confirmations), throttled prediction display, explicit streaming toggle/notice.
- **Services**:
  - `services/media/cameraService.js` centralizes camera stream handling.
  - `services/ml/modelBridge.js` uses TF.js to capture embeddings, train, and infer.
  - `services/ml/liveInference.js` runs the inference loop.
  - `services/ml/mockTraining.js` + `mockInference.js` remain as fallbacks for future tests.
  - `services/edge/edgeService.js` wraps BLE modules, tracks connection state, streams predictions to Arduino/Micro:bit/Calliope, and flags streaming errors as edge status updates; regression tests in `tests/store/sessionStore.edge.test.mjs` cover edge state persistence/contracts, `tests/services/edgeService.test.mjs` fakes the BLE stack to verify streaming toggles + error propagation end to end, and `docs/ble-hardware-qa.md` captures the release checklist for exercising real devices.
  - `src/config/externalResources.js` now pins the external TF.js/Mediapipe URLs that both the legacy prototype and SPA share, making version bumps + self-hosting plans explicit.

## Remaining Work to Fulfill `vision.md`

The edge-streaming parity/QA slice is complete (store persistence, modal UX, tests, and hardware checklist). To reach the full contract, tackle the remaining pillars in this order:

1. **Guard & destructive flow audit**
   - Ensure *every* destructive action (BLE disconnects, dataset resets outside Collect, session discard shortcuts, etc.) defers to the shared controllers with confirmations/toasts so state loss is always intentional.
2. **Accessibility + interaction standards (Quality bar)**
   - Finish the a11y checklist: focus traps for remaining modals, consistent keyboard shortcuts for critical flows, ARIA polish. These guardrails must be in place before ship-ready testing.
3. **Dependency pinning/self-hosting**
   - With `src/config/externalResources.js` in place, pin or mirror TF.js/Mediapipe assets per the vision so we control external drift and can satisfy offline/self-hosted requirements.
4. **Recording experience polish**
   - Build out the remaining annotation/metadata UX (post-scrub workflow, inline guidance) and finish integrating background-noise guidance into summary panels/CTAs so audio sessions stay aligned with `ml-speech`.
5. **UX polish & structure**
   - Continue migrating legacy utility classes to Tailwind and extract Home/Collect/Train/Infer logic into focused controllers/components so the SPA matches the architecture described in `vision.md`.
6. **Documentation & onboarding**
   - Keep this progress file up to date per sprint and expand the component/guard docs (`docs/components.md`) once the final structure settles so new contributors have a clear reference.

Keep referencing `refactoring-plans/vision.md` as the contract; this file tracks implementation status and outstanding work.
